#!/usr/bin/env bash

set -e

SLACK_RESOURCES_DIR=/Applications/Slack.app/Contents/Resources

function command_exists() {
  command -v $1 > /dev/null
  return $?
}

if [ ! -d "$SLACK_RESOURCES_DIR" ]; then
  echo "Couldn't find Slack resources dir ($SLACK_RESOURCES_DIR)"
  echo "Is it installed?"
  exit 1
else
  echo "âœ… Found dir $SLACK_RESOURCES_DIR"
fi

if ! command_exists npx; then
  echo "Could not find `npx`, please install"
else
  echo "âœ… npx found"
fi

NPX_PATH=$(type -P npx)

# unpack
echo "ðŸš€ unpacking asar archive for Slack (requires sudo)"
sudo "PATH=$PATH" $NPX_PATH asar extract $SLACK_RESOURCES_DIR/app.asar $SLACK_RESOURCES_DIR/app.asar.unpacked
echo "âœ… done"

JS_FILE="$SLACK_RESOURCES_DIR/app.asar.unpacked/dist/ssb-interop.bundle.js"
HEADER="// WYSIWYG patch"

if grep -q "$HEADER" "$JS_FILE" >/dev/null; then
  echo "ðŸŽ‰ Patch is already installed, exiting early"
  exit 0
fi

echo "ðŸš€ Patching $JS_FILE with code..."

cat << EOF | sudo tee -a "$JS_FILE" > /dev/null

$HEADER
(() => {
  const disableWysiwygEditor = (redux => () => {
    const {
      wysiwyg_composer,
      wysiwyg_composer_ios,
      wysiwyg_composer_webapp,
      ...payload
    } = redux.getState().experiments;

    redux.dispatch(
      {
        type: '[19] Bulk add experiment assignments to redux',
        payload
      }
    );
  });

  let currentTeamId = null;
  const seenTeams = {};

  setInterval(() => {
    if (!window.slackDebug) return;

    const { activeTeamId } = window.slackDebug;
    const newId = activeTeamId && activeTeamId !== currentTeamId

    if (newId && slackDebug[activeTeamId] && slackDebug[activeTeamId].redux) {
      currentTeamId = activeTeamId;
      const needsPatching = !seenTeams[activeTeamId];

      if (needsPatching) {
        const team = slackDebug[activeTeamId];

        if (team.redux) {
          setTimeout(disableWysiwygEditor(team.redux), 5000);
          seenTeams[activeTeamId] = true;
        }
      }
    }
  }, 50);
})();
// END patch
EOF

echo "âœ… done"

echo "ðŸš€ Repackaging asar for Slack..."
sudo "PATH=$PATH" $NPX_PATH asar pack $SLACK_RESOURCES_DIR/app.asar.unpacked $SLACK_RESOURCES_DIR/app.asar
echo "ðŸŽ‰ all done!"
